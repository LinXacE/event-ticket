{% extends "base.html" %}

{% block title %}Scanner - SmartEvents{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Header -->
            <div class="card border-0 shadow-sm mb-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <div class="card-body text-white py-4">
                    <h2 class="mb-2 text-center">
                        <i class="fas fa-camera me-2"></i>QR/Barcode Scanner
                    </h2>
                    <p class="mb-0 text-center opacity-75">Scan passes to validate event access</p>
                </div>
            </div>

            <div class="row">
                <!-- Scanner Section -->
                <div class="col-lg-6 mb-4">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-header bg-white py-3">
                            <h5 class="mb-0">
                                <i class="fas fa-qrcode text-primary me-2"></i>Camera Scanner
                            </h5>
                        </div>
                        <div class="card-body text-center">

                            <!-- Gate select (required) -->
                            <div class="mb-3 text-start">
                                <label class="form-label">Select Gate</label>
                                <select class="form-select form-select-lg" id="gate-select-camera" required>
                                    <option value="">-- Select Gate --</option>
                                </select>
                                <small class="text-muted">Gate is required for access rules.</small>
                            </div>

                            <!-- Camera View -->
                            <div id="scanner-container" class="mb-3" style="background: #000; border-radius: 10px; overflow: hidden;">
                                <video id="scanner-video" playsinline muted width="100%" height="300" style="display: block;"></video>
                                <canvas id="scanner-canvas" style="display: none;"></canvas>
                            </div>

                            <!-- Scanner Controls -->
                            <div class="d-grid gap-2">
                                <button id="start-scanner" class="btn btn-success btn-lg" type="button">
                                    <i class="fas fa-play me-2"></i>Start Scanner
                                </button>
                                <button id="stop-scanner" class="btn btn-danger btn-lg" type="button" style="display: none;">
                                    <i class="fas fa-stop me-2"></i>Stop Scanner
                                </button>
                            </div>

                            <!-- Status Messages -->
                            <div id="scanner-status" class="mt-3">
                                <p class="text-muted mb-0">
                                    <i class="fas fa-info-circle me-2"></i>Click "Start Scanner" to begin
                                </p>
                            </div>

                            <div class="mt-3 text-muted small text-start">
                                <strong>Note:</strong> Your current camera scanning loop is a placeholder. Manual entry works now,
                                and you can later plug in a real scanner library (jsQR / QuaggaJS).
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Manual Entry & Results -->
                <div class="col-lg-6 mb-4">
                    <!-- Manual Entry -->
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-header bg-white py-3">
                            <h5 class="mb-0">
                                <i class="fas fa-keyboard text-warning me-2"></i>Manual Entry
                            </h5>
                        </div>
                        <div class="card-body">
                            <form id="manual-validation-form">

                                <!-- Gate select (required) -->
                                <div class="mb-3">
                                    <label class="form-label">Select Gate</label>
                                    <select class="form-select form-select-lg" id="gate-select-manual" required>
                                        <option value="">-- Select Gate --</option>
                                    </select>
                                    <small class="text-muted">Gate is required for access rules.</small>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Pass Code</label>
                                    <input type="text" class="form-control form-control-lg"
                                           id="manual-code" placeholder="Enter pass code (QR content)" required>
                                </div>

                                <button type="submit" class="btn btn-primary btn-lg w-100">
                                    <i class="fas fa-check me-2"></i>Validate Pass
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Validation Result -->
                    <div id="validation-result" style="display: none;">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header py-3" id="result-header">
                                <h5 class="mb-0" id="result-title"></h5>
                            </div>
                            <div class="card-body" id="result-body"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Validations -->
            <div class="card border-0 shadow-sm mt-4">
                <div class="card-header bg-white py-3">
                    <h5 class="mb-0">
                        <i class="fas fa-history text-success me-2"></i>Recent Validations
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="validation-history">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Participant</th>
                                    <th>Pass Type</th>
                                    <th>Event</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="5" class="text-center text-muted">No validations yet</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<style>
    .card { border-radius: 15px; }
    #scanner-video { max-width: 100%; height: auto; }
    .validation-success { background-color: #d4edda; border-color: #c3e6cb; }
    .validation-error { background-color: #f8d7da; border-color: #f5c6cb; }
</style>

<script>
let videoStream = null;
let scanningInterval = null;

function setScannerStatus(html) {
    document.getElementById('scanner-status').innerHTML = html;
}

/**
 * Many browsers block webcam on HTTP unless it's localhost.
 * Your URL is http://192.168.x.x:5000 -> not secure -> camera blocked.
 */
function canUseCameraHere() {
    const isLocalhost =
        location.hostname === 'localhost' ||
        location.hostname === '127.0.0.1' ||
        location.hostname === '::1';

    // Must be secure context OR localhost
    if (!window.isSecureContext && !isLocalhost) {
        setScannerStatus(`
            <p class="text-danger mb-0">
                <i class="fas fa-exclamation-circle me-2"></i>
                Camera is blocked because this site is running on <b>HTTP</b> (${location.hostname}).
                <br>
                Use <b>https://</b> or run on <b>http://localhost</b> to enable camera access.
            </p>
        `);
        return false;
    }

    // Must have mediaDevices.getUserMedia available
    if (!navigator.mediaDevices || typeof navigator.mediaDevices.getUserMedia !== 'function') {
        setScannerStatus(`
            <p class="text-danger mb-0">
                <i class="fas fa-exclamation-circle me-2"></i>
                Camera API not available (<code>navigator.mediaDevices.getUserMedia</code>).
                <br>
                Try Chrome/Edge + HTTPS or localhost.
            </p>
        `);
        return false;
    }

    return true;
}

async function loadGates() {
    try {
        const res = await fetch('/gates/api/active');
        const data = await res.json();

        const cameraSel = document.getElementById('gate-select-camera');
        const manualSel = document.getElementById('gate-select-manual');

        const baseOption = '<option value="">-- Select Gate --</option>';
        cameraSel.innerHTML = baseOption;
        manualSel.innerHTML = baseOption;

        if (data.success && Array.isArray(data.gates) && data.gates.length) {
            data.gates.forEach(g => {
                const label = `${g.name} (${g.type}) - Event ${g.event_id}`;

                const opt1 = document.createElement('option');
                opt1.value = g.id;
                opt1.textContent = label;
                cameraSel.appendChild(opt1);

                const opt2 = document.createElement('option');
                opt2.value = g.id;
                opt2.textContent = label;
                manualSel.appendChild(opt2);
            });
        } else {
            cameraSel.innerHTML = '<option value="">No active gates found</option>';
            manualSel.innerHTML = '<option value="">No active gates found</option>';
        }
    } catch (e) {
        console.error('Failed to load gates', e);
        setScannerStatus(`
            <p class="text-danger mb-0">
                <i class="fas fa-exclamation-circle me-2"></i>
                Failed to load gates. Check <code>/gates/api/active</code>.
            </p>
        `);
    }
}

document.addEventListener('DOMContentLoaded', () => {
    loadGates();
    // show warning early (no crash)
    canUseCameraHere();
});

// Start scanner
document.getElementById('start-scanner').addEventListener('click', async () => {
    try {
        const gateId = document.getElementById('gate-select-camera').value;
        if (!gateId) {
            setScannerStatus('<p class="text-warning mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Please select a gate first.</p>');
            return;
        }

        // prevent crash on HTTP / missing API
        if (!canUseCameraHere()) return;

        const video = document.getElementById('scanner-video');

        // Optional confirm
        const permissionGranted = confirm(
            'ðŸ“· Camera Access Required\n\n' +
            'This QR scanner needs access to your camera to scan event passes. ' +
            'Please click "Allow" when your browser asks for camera permission.\n\n' +
            'Click OK to enable camera access.'
        );

        if (!permissionGranted) {
            setScannerStatus('<p class="text-warning mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Camera access was cancelled.</p>');
            return;
        }

        videoStream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: 'environment' },
            audio: false
        });

        video.srcObject = videoStream;
        await video.play();

        document.getElementById('start-scanner').style.display = 'none';
        document.getElementById('stop-scanner').style.display = 'block';
        setScannerStatus('<p class="text-success mb-0"><i class="fas fa-check-circle me-2"></i>Scanner active - Point camera at QR/Barcode</p>');

        startScanning();
    } catch (error) {
        console.error('Camera error:', error);
        let errorMessage = 'Camera error: ';

        if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
            errorMessage += 'Permission denied. Please allow camera access in your browser settings.';
        } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
            errorMessage += 'No camera found. Please connect a camera device.';
        } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
            errorMessage += 'Camera is already in use by another application.';
        } else if (error.name === 'OverconstrainedError' || error.name === 'ConstraintNotSatisfiedError') {
            errorMessage += 'Camera does not support rear-facing mode.';
        } else {
            errorMessage += (error.message || 'Unknown error occurred');
        }

        setScannerStatus(`<p class="text-danger mb-0"><i class="fas fa-exclamation-circle me-2"></i>${errorMessage}</p>`);
    }
});

// Stop scanner
document.getElementById('stop-scanner').addEventListener('click', () => stopScanner());

function stopScanner() {
    if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
        videoStream = null;
    }
    if (scanningInterval) {
        clearInterval(scanningInterval);
        scanningInterval = null;
    }
    document.getElementById('start-scanner').style.display = 'block';
    document.getElementById('stop-scanner').style.display = 'none';
    setScannerStatus('<p class="text-muted mb-0"><i class="fas fa-info-circle me-2"></i>Scanner stopped</p>');
}

function startScanning() {
    // Placeholder:
    // Plug in jsQR / QuaggaJS later, and call validatePass(scannedText, 'camera')
    scanningInterval = setInterval(() => {
        // scanning logic would go here
    }, 150);
}

// Manual validation form
document.getElementById('manual-validation-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const code = document.getElementById('manual-code').value.trim();
    await validatePass(code, 'manual');
});

async function validatePass(code, source) {
    try {
        const gateId =
            (source === 'manual')
                ? document.getElementById('gate-select-manual').value
                : document.getElementById('gate-select-camera').value;

        if (!gateId) {
            displayValidationResult({ message: "Please select a gate first." }, false);
            return;
        }

        const response = await fetch('/validate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code: code, gate_id: parseInt(gateId) })
        });

        const result = await response.json();
        displayValidationResult(result, response.ok);

        if (response.ok) addToHistory(result.pass_info);
    } catch (error) {
        displayValidationResult({ message: 'Connection error: ' + error.message }, false);
    }
}

function displayValidationResult(result, success) {
    const resultDiv = document.getElementById('validation-result');
    const resultHeader = document.getElementById('result-header');
    const resultTitle = document.getElementById('result-title');
    const resultBody = document.getElementById('result-body');

    resultDiv.style.display = 'block';

    if (success) {
        resultHeader.className = 'card-header py-3 validation-success';
        resultTitle.innerHTML = '<i class="fas fa-check-circle text-success me-2"></i>Validation Successful';
        resultBody.innerHTML = `
            <p class="mb-2"><strong>Participant:</strong> ${result.pass_info.participant_name ?? ''}</p>
            <p class="mb-2"><strong>Email:</strong> ${result.pass_info.email ?? ''}</p>
            <p class="mb-2"><strong>Pass Type:</strong> <span class="badge bg-primary">${result.pass_info.pass_type ?? ''}</span></p>
            <p class="mb-2"><strong>Event:</strong> ${result.pass_info.event ?? ''}</p>
            <p class="mb-0"><strong>Validated:</strong> ${result.pass_info.validated_at ?? ''}</p>
        `;
    } else {
        resultHeader.className = 'card-header py-3 validation-error';
        resultTitle.innerHTML = '<i class="fas fa-exclamation-circle text-danger me-2"></i>Validation Failed';
        resultBody.innerHTML = `<p class="mb-0 text-danger">${result.message ?? 'Validation failed'}</p>`;
    }

    setTimeout(() => { resultDiv.style.display = 'none'; }, 5000);
}

function addToHistory(passInfo) {
    const tbody = document.querySelector('#validation-history tbody');

    if (tbody.children.length === 1 && tbody.children[0].children.length === 1) {
        tbody.innerHTML = '';
    }

    const now = new Date();
    const timeStr = now.toLocaleTimeString();

    const row = tbody.insertRow(0);
    row.innerHTML = `
        <td>${timeStr}</td>
        <td>${passInfo.participant_name ?? ''}</td>
        <td><span class="badge bg-primary">${passInfo.pass_type ?? ''}</span></td>
        <td>${passInfo.event ?? ''}</td>
        <td><span class="badge bg-success">Validated</span></td>
    `;

    while (tbody.children.length > 10) tbody.removeChild(tbody.lastChild);
}
</script>
{% endblock %}
